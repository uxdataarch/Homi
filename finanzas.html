<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homi - Finanzas del hogar</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #F2F2F2;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: #5DA7E7;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        .menu-btn { font-size: 28px; cursor: pointer; background: none; border: none; color: white; padding: 5px; }

        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 20px;
            font-weight: 600;
        }

        .logo-small {
            width: 50px; height: 50px;
            background: #A9E5BB;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: transform .3s;
        }

        .logo-small:hover { transform: scale(1.1); }

        /* Contenedor principal */
        .finance-container { padding: 20px; max-width: 1200px; margin: 0 auto; }

        /* Resumen financiero */
        .summary-card {
            background: white; border-radius: 20px; padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .summary-row {
            display: flex; justify-content: space-around;
            margin-bottom: 25px; gap: 20px;
        }

        .summary-item { text-align: center; flex: 1; }
        .summary-label { font-size: 18px; font-weight: 600; color: #4A4A4A; margin-bottom: 10px; }
        .summary-amount { font-size: 32px; font-weight: 700; }
        .amount-income { color: #A9E5BB; }
        .amount-expense { color: #ff6b6b; }

        .available-section { text-align: center; padding-top: 20px; border-top: 2px solid #F2F2F2; }
        .available-label { font-size: 20px; font-weight: 600; color: #4A4A4A; margin-bottom: 10px; }
        .available-amount { font-size: 36px; font-weight: 700; color: #4A4A4A; }

        .action-buttons { display:flex; gap:15px; margin-bottom:30px; }

        .action-btn {
            flex:1; padding:16px; border-radius:15px; border:none;
            font-size:16px; font-weight:600; cursor:pointer;
            display:flex; align-items:center; justify-content:center; gap:8px;
            box-shadow:0 4px 15px rgba(0,0,0,0.1);
            transition:.3s;
        }

        .btn-income { background:#A9E5BB; color:white; }
        .btn-expense { background:#ff6b6b; color:white; }

        .action-btn:hover { transform: translateY(-2px); }

        /* Movimientos */
        .movements-section {
            background:white; border-radius:20px; padding:25px;
            box-shadow:0 2px 10px rgba(0,0,0,0.05);
        }

        .movements-title { font-size:22px; font-weight:700; margin-bottom:20px; color:#4A4A4A; }

        .movement-item {
            display:flex; align-items:center; justify-content:space-between;
            padding:15px; background:#F2F2F2; border-radius:12px;
            margin-bottom:12px; transition:.3s;
        }

        .movement-item:hover { background:#e8e8e8; transform: translateX(5px); }
        .movement-info { flex: 1; }
        .movement-name { font-size:18px; font-weight:600; margin-bottom:5px; color:#4A4A4A; }
        .movement-details { font-size:13px; color:#666; }
        .movement-amount { font-size:22px; font-weight:700; white-space: nowrap; }

        .amount-positive { color:#A9E5BB; }
        .amount-negative { color:#ff6b6b; }

        /* Modal */
        .modal {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); z-index:1000;
            justify-content:center; align-items:center; padding:20px;
        }
        .modal.active { display:flex; }

        .modal-content {
            background:white; border-radius:20px;
            padding:30px; width:100%; max-width:500px; max-height:90vh; overflow-y:auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }

        .back-btn {
            font-size: 30px;
            cursor: pointer;
            border: none;
            background: none;
            color: #4A4A4A;
            padding: 0;
            margin-right: 15px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #4A4A4A;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #4A4A4A;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #F2F2F2;
            border-radius: 10px;
            font-size: 15px;
            color: #4A4A4A;
            background: #F2F2F2;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #5DA7E7;
            background: white;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-save {
            background: #A9E5BB;
            color: white;
        }

        .btn-cancel {
            background: #ff6b6b;
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* PDF button */
        #exportPDF {
            background:#5DA7E7; color:white;
            border:none; border-radius:10px;
            padding:12px 18px; cursor:pointer;
            font-size:16px; font-weight:600;
            margin-bottom:20px;
        }

        #exportPDF:hover {
            background: #4d96d6;
        }

        @media (max-width: 768px) {
            .summary-row {
                flex-direction: column;
            }
            .action-buttons {
                flex-direction: column;
            }
            .movement-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .movement-amount {
                align-self: flex-end;
            }
        }
    </style>
</head>

<body>

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <button class="menu-btn" onclick="window.location.href='home.html'">‚ò∞</button>
            <div class="header-title">üí∞ Finanzas del hogar</div>
        </div>
        <div class="logo-small" onclick="window.location.href='home.html'">
            <img src="logo.png" style="width:70%;height:70%;object-fit:contain;border-radius:50%;">
        </div>
    </div>

    <div class="finance-container">

        <!-- Resumen financiero -->
        <div class="summary-card">
            <div class="summary-row">
                <div class="summary-item">
                    <div class="summary-label">Ingresos</div>
                    <div class="summary-amount amount-income" id="totalIncome">$0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Gastos</div>
                    <div class="summary-amount amount-expense" id="totalExpense">$0</div>
                </div>
            </div>
            <div class="available-section">
                <div class="available-label">Disponible</div>
                <div class="available-amount" id="available">$0</div>
            </div>
        </div>

        <!-- Botones -->
        <div class="action-buttons">
            <button class="action-btn btn-income" id="btnIngreso">+ Ingreso</button>
            <button class="action-btn btn-expense" id="btnGasto">+ Gasto</button>
        </div>

        <!-- PDF -->
        <button id="exportPDF">üìÑ Exportar PDF (mes actual)</button>

        <!-- Movimientos -->
        <div class="movements-section">
            <h2 class="movements-title">√öltimos movimientos</h2>
            <div id="movementsList"></div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="financeModal">
        <div class="modal-content">

            <div class="modal-header">
                <button class="back-btn" id="btnBack">‚Üê</button>
                <div class="modal-title" id="modalTitle">Nuevo movimiento</div>
            </div>

            <form id="financeForm">
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select id="inputTipo" class="form-select">
                        <option value="ingreso">Ingreso</option>
                        <option value="gasto">Gasto</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Monto *</label>
                    <input id="inputMonto" type="number" step="0.01" class="form-input" placeholder="$ 0.00" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Categor√≠a *</label>
                    <input id="inputCategoria" class="form-input" placeholder="Ej: Supermercado, Salario..." required>
                </div>

                <div class="form-group">
                    <label class="form-label">Fecha *</label>
                    <input id="inputFecha" type="date" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Nota</label>
                    <textarea id="inputNota" class="form-textarea" placeholder="Agrega una descripci√≥n..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="modal-btn btn-save">‚úì Guardar</button>
                    <button type="button" class="modal-btn btn-cancel" id="btnCancelar">‚úó Cancelar</button>
                </div>
            </form>

        </div>
    </div>

<script type="module">

/* ----------------- IMPORTAR FIREBASE ----------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
    getFirestore,
    collection,
    addDoc,
    query,
    where,
    getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* CONFIG FIREBASE */
const firebaseConfig = {
    apiKey: "AIzaSyC_eDl442o_5UR1jburjFrBSzqLBC9bX2w",
    authDomain: "homi-29ba2.firebaseapp.com",
    projectId: "homi-29ba2",
    storageBucket: "homi-29ba2.firebasestorage.app",
    messagingSenderId: "1066841499256",
    appId: "1:1066841499256:web:0095d2eec75241be3d6f8d",
    measurementId: "G-5ZFW0LP6BC"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ----------------- VARIABLES ----------------- */
let currentUser = null;
let currentType = "ingreso";

/* ----------------- AUTENTICACI√ìN ----------------- */
onAuthStateChanged(auth, (user) => {
    if (!user) {
        window.location.href = "index.html";
        return;
    }
    currentUser = user;
    loadMovements();
});

/* ----------------- MODAL ----------------- */
function openModal(type) {
    currentType = type;
    document.getElementById("inputTipo").value = type;
    document.getElementById("modalTitle").textContent =
        type === "ingreso" ? "Nuevo ingreso" : "Nuevo gasto";

    // Setear fecha de hoy
    document.getElementById("inputFecha").value = new Date().toISOString().slice(0, 10);

    document.getElementById("financeModal").classList.add("active");
}

function closeModal() {
    document.getElementById("financeModal").classList.remove("active");
    document.getElementById("financeForm").reset();
}

/* ----------------- EVENT LISTENERS PARA BOTONES ----------------- */
document.getElementById("btnIngreso").addEventListener("click", () => openModal('ingreso'));
document.getElementById("btnGasto").addEventListener("click", () => openModal('gasto'));
document.getElementById("btnCancelar").addEventListener("click", closeModal);
document.getElementById("btnBack").addEventListener("click", closeModal);

// Cerrar modal al hacer clic fuera
document.getElementById("financeModal").addEventListener("click", (e) => {
    if (e.target.id === "financeModal") closeModal();
});

/* ----------------- GUARDAR MOVIMIENTO ----------------- */
document.getElementById("financeForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const tipo = document.getElementById("inputTipo").value;
    const monto = Number(document.getElementById("inputMonto").value);
    const categoria = document.getElementById("inputCategoria").value.trim();
    const fecha = document.getElementById("inputFecha").value;
    const nota = document.getElementById("inputNota").value.trim();

    if (!monto || !categoria || !fecha) {
        alert("Completa todos los campos obligatorios");
        return;
    }

    try {
        await addDoc(collection(db, "finanzas"), {
            uid: currentUser.uid,
            tipo: tipo,
            monto: monto,
            categoria: categoria,
            descripcion: nota || categoria,
            fecha: fecha,
            timestamp: Date.now()
        });

        closeModal();
        loadMovements();
    } catch (error) {
        console.error("Error al guardar:", error);
        alert("Error al guardar el movimiento");
    }
});

/* ----------------- CARGAR MOVIMIENTOS ----------------- */
async function loadMovements() {
    if (!currentUser) return;

    try {
        // Sin orderBy para evitar error de √≠ndice
        const q = query(
            collection(db, "finanzas"),
            where("uid", "==", currentUser.uid)
        );

        const snap = await getDocs(q);
        const data = [];
        snap.forEach(doc => data.push({ id: doc.id, ...doc.data() }));

        // Ordenar manualmente por timestamp (desc)
        data.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        renderMovements(data);
        updateSummary(data);
    } catch (error) {
        console.error("Error al cargar:", error);
        alert("Error al cargar movimientos. Revisa la consola.");
    }
}

/* ----------------- RENDERIZAR MOVIMIENTOS ----------------- */
function renderMovements(arr) {
    const list = document.getElementById("movementsList");
    list.innerHTML = "";

    if (arr.length === 0) {
        list.innerHTML = '<p style="color:#666;text-align:center;padding:20px;">No hay movimientos registrados</p>';
        return;
    }

    arr.forEach(m => {
        const div = document.createElement("div");
        div.className = "movement-item";

        const montoFormat = new Intl.NumberFormat('es-MX', {
            style: 'currency',
            currency: 'MXN'
        }).format(m.monto || 0);

        div.innerHTML = `
            <div class="movement-info">
                <div class="movement-name">${escapeHtml(m.descripcion || m.categoria)}</div>
                <div class="movement-details">
                    ${m.fecha || 'Sin fecha'} ‚Ä¢ ${escapeHtml(m.categoria || '')}
                </div>
            </div>

            <div class="movement-amount ${m.tipo === "ingreso" ? "amount-positive" : "amount-negative"}">
                ${m.tipo === "ingreso" ? "+" : "-"} ${montoFormat}
            </div>
        `;

        list.appendChild(div);
    });
}

/* ----------------- RESUMEN ----------------- */
function updateSummary(arr) {
    let ingresos = 0;
    let gastos = 0;

    arr.forEach(m => {
        const monto = Number(m.monto) || 0;
        if (m.tipo === "ingreso") {
            ingresos += monto;
        } else {
            gastos += monto;
        }
    });

    const formatCurrency = (num) => {
        return new Intl.NumberFormat('es-MX', {
            style: 'currency',
            currency: 'MXN'
        }).format(num);
    };

    document.getElementById("totalIncome").textContent = formatCurrency(ingresos);
    document.getElementById("totalExpense").textContent = formatCurrency(gastos);
    document.getElementById("available").textContent = formatCurrency(ingresos - gastos);
}

/* ----------------- EXPORTAR PDF ----------------- */
document.getElementById("exportPDF").addEventListener("click", async () => {
    try {
        // Verificar si jsPDF est√° disponible
        if (typeof window.jspdf === 'undefined') {
            alert("Cargando librer√≠a PDF...");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // T√≠tulo principal
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text("HOMI - Finanzas del Hogar", 105, 20, { align: 'center' });
        
        // Subt√≠tulo con mes actual
        const now = new Date();
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                           "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const currentMonth = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
        
        doc.setFontSize(14);
        doc.setFont(undefined, 'normal');
        doc.text(`Reporte del mes: ${currentMonth}`, 105, 30, { align: 'center' });
        
        // L√≠nea separadora
        doc.setLineWidth(0.5);
        doc.line(20, 35, 190, 35);
        
        // Obtener datos actuales
        const ingresoText = document.getElementById("totalIncome").textContent;
        const gastoText = document.getElementById("totalExpense").textContent;
        const disponibleText = document.getElementById("available").textContent;
        
        // Resumen financiero
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text("Resumen Financiero", 20, 45);
        
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(169, 229, 187); // Verde para ingresos
        doc.text(`Ingresos: ${ingresoText}`, 30, 55);
        
        doc.setTextColor(255, 107, 107); // Rojo para gastos
        doc.text(`Gastos: ${gastoText}`, 30, 65);
        
        doc.setTextColor(74, 74, 74); // Gris oscuro para disponible
        doc.text(`Disponible: ${disponibleText}`, 30, 75);
        
        // L√≠nea separadora
        doc.setDrawColor(0, 0, 0);
        doc.line(20, 82, 190, 82);
        
        // √öltimos movimientos
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text("√öltimos Movimientos", 20, 92);
        
        // Obtener movimientos del DOM
        const movements = document.querySelectorAll('.movement-item');
        let yPos = 102;
        const maxMovements = 15; // M√°ximo de movimientos en una p√°gina
        let count = 0;
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        
        movements.forEach((mov, index) => {
            if (count >= maxMovements) return; // Limitar a una p√°gina
            
            const name = mov.querySelector('.movement-name').textContent;
            const details = mov.querySelector('.movement-details').textContent;
            const amount = mov.querySelector('.movement-amount').textContent;
            const isIncome = mov.querySelector('.amount-positive') !== null;
            
            // Color seg√∫n tipo
            if (isIncome) {
                doc.setTextColor(169, 229, 187); // Verde
            } else {
                doc.setTextColor(255, 107, 107); // Rojo
            }
            
            // Nombre y monto
            doc.text(name, 25, yPos);
            doc.text(amount, 170, yPos, { align: 'right' });
            
            // Detalles en gris
            doc.setTextColor(150, 150, 150);
            doc.setFontSize(8);
            doc.text(details, 25, yPos + 4);
            
            yPos += 12;
            count++;
            doc.setFontSize(10);
        });
        
        // Footer
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(`Generado el ${now.toLocaleDateString('es-MX')} a las ${now.toLocaleTimeString('es-MX')}`, 105, 280, { align: 'center' });
        doc.text("www.homi-app.com", 105, 285, { align: 'center' });
        
        // Guardar
        doc.save(`Finanzas_Homi_${currentMonth.replace(' ', '_')}.pdf`);
        
    } catch (error) {
        console.error("Error al generar PDF:", error);
        alert("Error al generar el PDF. Por favor intenta de nuevo.");
    }
});

/* ----------------- ESCAPE HTML ----------------- */
function escapeHtml(text) {
    if (!text) return "";
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

</script>

<!-- jsPDF Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>