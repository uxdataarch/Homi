<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Homi - Inventario</title>
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#F2F2F2;min-height:100vh}

    /* Header */
    .header{background:#5DA7E7;padding:20px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
    .header-left{display:flex;align-items:center;gap:15px}
    .menu-btn{font-size:28px;cursor:pointer;background:none;border:none;color:white;padding:5px}
    .header-title{display:flex;align-items:center;gap:10px;color:white;font-size:20px;font-weight:600}
    .logo-small{width:50px;height:50px;background:#A9E5BB;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:25px;cursor:pointer;transition:transform .3s}
    .logo-small:hover{transform:scale(1.1)}

    /* Top controls */
    .controls{padding:18px 20px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .filter-btn{padding:10px 16px;border-radius:20px;border:none;background:#fff;color:#4A4A4A;font-weight:600;cursor:pointer}
    .filter-btn.active{background:#5DA7E7;color:#fff}
    .search-input{margin-left:auto;padding:10px 14px;border-radius:12px;border:2px solid #F2F2F2;background:#fff;width:220px}
    .add-btn{width:50px;height:50px;border-radius:50%;background:#A9E5BB;border:none;color:white;font-size:28px;cursor:pointer;box-shadow:0 4px 15px rgba(169,229,187,0.4)}

    /* Container */
    .inventory-container{padding:0 20px 40px;max-width:1200px;margin:0 auto}

    .product-card{background:white;border-radius:15px;padding:18px;margin-bottom:12px;box-shadow:0 2px 10px rgba(0,0,0,0.05);display:flex;align-items:center;gap:14px;transition:all .2s}
    .product-card:hover{transform:translateY(-3px);box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    .product-icon{width:48px;height:48px;background:#F2F2F2;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
    .product-info{flex:1}
    .product-name{font-size:18px;font-weight:700;color:#4A4A4A;margin-bottom:6px}
    .product-details{display:flex;flex-wrap:wrap;gap:8px;font-size:14px;color:#666}
    .detail-label{font-weight:600;color:#4A4A4A;margin-right:6px}
    .prod-actions{display:flex;gap:8px;align-items:center}
    .btn-small{padding:8px 10px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .btn-edit{background:#5DA7E7;color:white}
    .btn-delete{background:#ff6b6b;color:white}
    .btn-out{background:#A9E5BB;color:white}

    /* Status badges */
    .badge{padding:6px 10px;border-radius:12px;font-weight:700;font-size:12px}
    .badge.expired{background:#ff6b6b;color:white}
    .badge.soon{background:#ffcf6b;color:#4A4A4A}
    .badge.ok{background:#A9E5BB;color:white}
    .badge.out{background:#999;color:white}

    /* Out of stock */
    .product-card.out-of-stock{opacity:.6;border:2px dashed #ccc}

    /* Modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.45);z-index:1200;justify-content:center;align-items:center;padding:18px}
    .modal.active{display:flex}
    .modal-content{background:white;border-radius:14px;padding:22px;max-width:520px;width:100%;max-height:90vh;overflow-y:auto}
    .modal-title{font-size:18px;font-weight:700;margin-bottom:12px}
    .form-group{margin-bottom:12px}
    .form-input,.form-select{width:100%;padding:10px;border-radius:10px;border:2px solid #F2F2F2;background:#F2F2F2}
    .modal-actions{display:flex;gap:10px;margin-top:14px}
    .modal .btn-save{background:#A9E5BB;color:white;padding:10px 14px;border-radius:10px;border:none}
    .modal .btn-cancel{background:#ff6b6b;color:white;padding:10px 14px;border-radius:10px;border:none}

    /* Toast */
    .toast{position:fixed;right:18px;bottom:18px;background:#333;color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;opacity:0;transform:translateY(10px);transition:all .28s;z-index:2000}
    .toast.show{opacity:1;transform:translateY(0)}

    @media (max-width:700px){
        .search-input{width:120px}
        .product-details{font-size:13px}
    }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <div class="header-left">
        <button class="menu-btn" onclick="window.location.href='home.html'">â˜°</button>
        <div class="header-title">ðŸ“¦ Inventario</div>
    </div>
    <div class="logo-small" onclick="window.location.href='home.html'">
        <img src="logo.png" alt="logo" style="width:70%;height:70%;border-radius:50%">
    </div>
</div>

<!-- CONTROLS -->
<div class="controls">
    <button class="filter-btn active" data-filter="all">Todos</button>
    <button class="filter-btn" data-filter="perecedero">Perecederos</button>
    <button class="filter-btn" data-filter="no-perecedero">No perecederos</button>
    <button class="filter-btn" data-filter="por-caducar">Por caducar</button>
    <button class="filter-btn" data-filter="agotados">Agotados</button>

    <input id="searchInput" class="search-input" placeholder="Buscar producto..." />

    <button class="add-btn" id="openAdd">+</button>
</div>

<!-- LIST -->
<div class="inventory-container" id="inventoryContainer"></div>

<!-- MODAL -->
<div class="modal" id="productModal">
    <div class="modal-content">
        <div class="modal-title" id="modalTitle">Nuevo producto</div>

        <form id="productForm">
            <div class="form-group">
                <label class="form-label">Nombre</label>
                <input class="form-input" id="inputName" required />
            </div>

            <div class="form-group">
                <label class="form-label">Tipo</label>
                <select class="form-select" id="inputType" required>
                    <option value="">Seleccionar</option>
                    <option value="perecedero">Perecedero</option>
                    <option value="no-perecedero">No perecedero</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Fecha de compra</label>
                <input type="date" class="form-input" id="inputPurchaseDate" required />
            </div>

            <div class="form-group" id="shelfGroup">
                <label class="form-label">Tiempo de vida Ãºtil (ej: 7 dÃ­as, 2 semanas, 1 mes)</label>
                <input class="form-input" id="inputShelfLife" placeholder="Ej: 7 dÃ­as" />
                <div class="form-note">Solo necesario para perecederos</div>
            </div>

            <div class="form-group">
                <label class="form-label">Cantidad</label>
                <div style="display:flex;gap:8px">
                    <input type="number" min="0" class="form-input" id="inputQuantity" style="flex:2" required />
                    <select class="form-select" id="inputUnit" style="flex:1" required>
                        <option value="">Medida</option>
                        <option value="gr">gr</option>
                        <option value="kg">kg</option>
                        <option value="ml">ml</option>
                        <option value="l">l</option>
                        <option value="piezas">piezas</option>
                        <option value="unidades">unidades</option>
                        <option value="cajas">cajas</option>
                        <option value="paquetes">paquetes</option>
                    </select>
                </div>
            </div>

            <div class="modal-actions">
                <button type="submit" class="btn-save">Guardar</button>
                <button type="button" class="btn-cancel" id="cancelBtn">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast">Guardado</div>

<script type="module">
/* =========================
   FIREBASE + LÃ“GICA CRUD
   ========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
    getFirestore, collection, addDoc, query, where, onSnapshot,
    doc, updateDoc, deleteDoc, getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyC_eDl442o_5UR1jburjFrBSzqLBC9bX2w",
    authDomain: "homi-29ba2.firebaseapp.com",
    projectId: "homi-29ba2",
    storageBucket: "homi-29ba2.firebasestorage.app",
    messagingSenderId: "1066841499256",
    appId: "1:1066841499256:web:0095d2eec75241be3d6f8d",
    measurementId: "G-5ZFW0LP6BC"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// export for potential non-module parts (not required but safe)
window.db = db;
window.doc = doc;
window.updateDoc = updateDoc;
window.deleteDoc = deleteDoc;
window.getDoc = getDoc;

let currentUser = null;
window.editingItemId = null;

/* ---------- UTILIDADES FECHAS ---------- */
function formatDateDisplay(iso) {
    if (!iso) return "â€”";
    const d = new Date(iso);
    if (isNaN(d)) return iso;
    const day = String(d.getDate()).padStart(2, "0");
    const month = String(d.getMonth()+1).padStart(2, "0");
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
}
function toInputDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (isNaN(d)) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
}

/* parsea shelf life como "7 dÃ­as", "2 semanas", "1 mes" -> devuelve ISO date */
function computeExpireDate(purchaseIso, shelfLifeStr) {
    if (!purchaseIso || !shelfLifeStr) return null;
    const base = new Date(purchaseIso);
    if (isNaN(base)) return null;

    // normalize
    const s = String(shelfLifeStr).trim().toLowerCase();

    // try to extract number
    const numMatch = s.match(/(\d+(\.\d+)?)/);
    const n = numMatch ? Number(numMatch[1]) : 1;

    // days
    if (s.includes("dÃ­a") || s.includes("dias") || s.includes("dÃ­as")) {
        base.setDate(base.getDate() + Math.round(n));
        return base.toISOString();
    }
    // semanas
    if (s.includes("semana") || s.includes("semanas")) {
        base.setDate(base.getDate() + Math.round(n * 7));
        return base.toISOString();
    }
    // mes/meses
    if (s.includes("mes")) {
        base.setMonth(base.getMonth() + Math.round(n));
        return base.toISOString();
    }
    // aÃ±o/aÃ±os
    if (s.includes("aÃ±o") || s.includes("ano") || s.includes("aÃ±os")) {
        base.setFullYear(base.getFullYear() + Math.round(n));
        return base.toISOString();
    }
    // fallback: if contains only number treat as days
    if (!isNaN(n)) {
        base.setDate(base.getDate() + Math.round(n));
        return base.toISOString();
    }
    return null;
}

/* determine badge: expired / soon (3 days) / ok */
function computeStatus(expireIso) {
    if (!expireIso) return "ok";
    const today = new Date(); today.setHours(0,0,0,0);
    const exp = new Date(expireIso); exp.setHours(0,0,0,0);
    if (exp < today) return "expired";
    const diffMs = exp - today;
    const diffDays = Math.ceil(diffMs / (1000*60*60*24));
    if (diffDays <= 3) return "soon";
    return "ok";
}

/* escape minimal */
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

/* ---------- AUTH CHECK ---------- */
onAuthStateChanged(auth, (user) => {
    if(!user){
        window.location.href = "index.html";
        return;
    }
    currentUser = user;
    loadInventory();
});

/* ---------- UI ELEMENTS ---------- */
const container = document.getElementById("inventoryContainer");
const modal = document.getElementById("productModal");
const form = document.getElementById("productForm");
const modalTitle = document.getElementById("modalTitle");
const toastEl = document.getElementById("toast");
const searchInput = document.getElementById("searchInput");
const filterButtons = document.querySelectorAll(".filter-btn");

/* show toast */
function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(()=> toastEl.classList.remove("show"),2200);
}

/* ---------- LOAD & RENDER ---------- */
let latestItemsCache = []; // array of items from snapshot

function loadInventory(){
    if(!currentUser) return;
    const q = query(collection(db,"inventory"), where("uid","==",currentUser.uid));
    onSnapshot(q, (snapshot) => {
        const arr = [];
        snapshot.forEach(d => arr.push({ id: d.id, ...d.data() }));
        // sort: expireDate asc (nulls last), then name
        arr.sort((a,b) => {
            if (!a.expireDate && b.expireDate) return 1;
            if (a.expireDate && !b.expireDate) return -1;
            if (!a.expireDate && !b.expireDate) return a.name.localeCompare(b.name);
            const da = new Date(a.expireDate), db_ = new Date(b.expireDate);
            if (da - db_ !== 0) return da - db_;
            return (a.name||"").localeCompare(b.name||"");
        });

        latestItemsCache = arr;
        renderList(arr);
    }, err => {
        console.error("snapshot err", err);
    });
}

function renderList(items){
    container.innerHTML = "";
    const filter = document.querySelector(".filter-btn.active").dataset.filter || "all";
    const qText = (searchInput.value || "").trim().toLowerCase();

    const filtered = items.filter(it => {
        // text search
        if (qText) {
            const hay = (it.name||"").toLowerCase() + " " + (it.type||"");
            if (!hay.includes(qText)) return false;
        }
        // filter types
        if (filter === "perecedero" && it.type !== "perecedero") return false;
        if (filter === "no-perecedero" && it.type !== "no-perecedero") return false;
        if (filter === "agotados" && it.outOfStock !== true) return false;
        if (filter === "por-caducar") {
            // include those with expireDate and not expired? show soon+expired
            if (!it.expireDate) return false;
            const st = computeStatus(it.expireDate);
            if (st === "ok") return false;
        }
        return true;
    });

    if(filtered.length === 0) container.innerHTML = `<div style="padding:20px;color:#666">No hay productos</div>`;

    filtered.forEach(it => {
        const card = document.createElement("div");
        card.className = "product-card";
        if (it.outOfStock) card.classList.add("out-of-stock");

        const status = computeStatus(it.expireDate);
        let badgeHtml = "";
        if (it.outOfStock) badgeHtml = `<span class="badge out">AGOTADO</span>`;
        else if (it.type === "perecedero") {
            if (status === "expired") badgeHtml = `<span class="badge expired">VENCIDO</span>`;
            else if (status === "soon") badgeHtml = `<span class="badge soon">POR CADUCAR</span>`;
            else badgeHtml = `<span class="badge ok">OK</span>`;
        } else {
            badgeHtml = `<span class="badge ok">NO PERECEDERO</span>`;
        }

        const expireDisplay = it.expireDate ? formatDateDisplay(it.expireDate) : "â€”";
        const purchaseDisplay = it.purchaseDate ? formatDateDisplay(it.purchaseDate) : "â€”";

        card.innerHTML = `
            <div class="product-icon">ðŸ“¦</div>
            <div class="product-info">
                <div style="display:flex;align-items:center;gap:10px">
                    <div class="product-name">${escapeHtml(it.name)}</div>
                    ${badgeHtml}
                </div>
                <div class="product-details">
                    <div class="product-detail-row"><span class="detail-label">Tipo:</span><span>${it.type || 'â€”'}</span></div>
                    <div class="product-detail-row"><span class="detail-label">Compra:</span><span>${purchaseDisplay}</span></div>
                    <div class="product-detail-row"><span class="detail-label">Caduca:</span><span>${expireDisplay}</span></div>
                    <div class="product-detail-row"><span class="detail-label">Cantidad:</span><span>${it.quantity} ${it.unit || ''}</span></div>
                </div>
            </div>
            <div class="prod-actions">
                <button class="btn-small btn-out" data-id="${it.id}">${it.outOfStock ? 'Restock' : 'Agotado'}</button>
                <button class="btn-small btn-edit" data-id="${it.id}">âœŽ</button>
                <button class="btn-small btn-delete" data-id="${it.id}">âœ—</button>
            </div>
        `;
        container.appendChild(card);
    });

    attachCardEvents();
}

/* ---------- attach events to rendered cards ---------- */
function attachCardEvents(){
    // edit
    document.querySelectorAll(".btn-edit").forEach(b=>{
        b.onclick = async () => {
            const id = b.dataset.id;
            try {
                const ref = doc(db,"inventory",id);
                const snap = await getDoc(ref);
                if(!snap.exists()){ showToast("No encontrado"); return; }
                const data = snap.data();
                // fill form
                document.getElementById("inputName").value = data.name || "";
                document.getElementById("inputType").value = data.type || "";
                document.getElementById("inputPurchaseDate").value = toInputDate(data.purchaseDate) || "";
                document.getElementById("inputShelfLife").value = data.shelfLife || "";
                document.getElementById("inputQuantity").value = data.quantity || 0;
                document.getElementById("inputUnit").value = data.unit || "";
                // set editing
                window.editingItemId = id;
                modalTitle.textContent = "Editar producto";
                // show modal
                modal.classList.add("active");
                // toggle shelf field visibility
                toggleShelfField();
            } catch(err){ console.error(err); showToast("Error al cargar"); }
        };
    });

    // delete
    document.querySelectorAll(".btn-delete").forEach(b=>{
        b.onclick = async () => {
            const id = b.dataset.id;
            if(!confirm("Eliminar producto?")) return;
            try {
                await deleteDoc(doc(db,"inventory",id));
                showToast("Eliminado");
            } catch(err){ console.error(err); showToast("Error"); }
        };
    });

    // mark out of stock / restock
    document.querySelectorAll(".btn-out").forEach(b=>{
        b.onclick = async () => {
            const id = b.dataset.id;
            try {
                const ref = doc(db,"inventory",id);
                const snap = await getDoc(ref);
                if(!snap.exists()){ showToast("No encontrado"); return; }
                const data = snap.data();
                const newVal = !data.outOfStock;
                await updateDoc(ref, { outOfStock: newVal });
                showToast(newVal ? "Marcado como agotado" : "Restock realizado");
            } catch(err){ console.error(err); showToast("Error"); }
        };
    });
}

/* ---------- Filters & search ---------- */
filterButtons.forEach(b=>{
    b.onclick = () => {
        filterButtons.forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        renderList(latestItemsCache);
    };
});
searchInput.addEventListener("input", ()=> renderList(latestItemsCache));

/* ---------- Modal open/create ---------- */
document.getElementById("openAdd").onclick = () => {
    window.editingItemId = null;
    modalTitle.textContent = "Nuevo producto";
    form.reset();
    document.getElementById("inputUnit").value = "";
    toggleShelfField();
    modal.classList.add("active");
};
document.getElementById("cancelBtn").onclick = () => {
    modal.classList.remove("active");
    window.editingItemId = null;
};

/* toggle shelf field depending on type */
function toggleShelfField(){
    const type = document.getElementById("inputType").value;
    const shelfGroup = document.getElementById("shelfGroup");
    if(type === "perecedero"){
        shelfGroup.style.display = "block";
    } else {
        shelfGroup.style.display = "none";
    }
}
document.getElementById("inputType").addEventListener("change", toggleShelfField);

/* ---------- Form submit (create / update) ---------- */
form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const name = document.getElementById("inputName").value.trim();
    const type = document.getElementById("inputType").value;
    const purchaseDate = document.getElementById("inputPurchaseDate").value;
    const shelfLife = document.getElementById("inputShelfLife").value.trim();
    const quantity = Number(document.getElementById("inputQuantity").value) || 0;
    const unit = document.getElementById("inputUnit").value;

    if(!name || !type || !purchaseDate || !unit){ showToast("Completa los campos obligatorios"); return; }

    // compute ISO for purchase (midnight local)
    const parts = purchaseDate.split("-");
    const purchaseIso = new Date(Number(parts[0]), Number(parts[1])-1, Number(parts[2])).toISOString();

    let expireIso = null;
    if(type === "perecedero"){
        expireIso = computeExpireDate(purchaseIso, shelfLife) || null;
    }

    try {
        if(window.editingItemId){
            const ref = doc(db,"inventory",window.editingItemId);
            await updateDoc(ref, {
                name, type, purchaseDate: purchaseIso, shelfLife: shelfLife||null,
                quantity, unit, expireDate: expireIso || null
            });
            showToast("Actualizado");
            window.editingItemId = null;
        } else {
            await addDoc(collection(db,"inventory"), {
                name, type, purchaseDate: purchaseIso, shelfLife: shelfLife||null,
                quantity, unit, expireDate: expireIso || null,
                uid: currentUser.uid, outOfStock: false, createdAt: Date.now()
            });
            showToast("Guardado");
        }
        modal.classList.remove("active");
        form.reset();
    } catch(err){
        console.error(err);
        showToast("Error al guardar");
    }
});

/* close modal on outside click */
modal.addEventListener("click", (e)=>{
    if(e.target === modal) modal.classList.remove("active");
});
</script>
</body>
</html>
